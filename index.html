<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pure AR Camera Fix</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* شفافیت مطلق */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: transparent !important; 
            overflow: hidden;
        }
        canvas { 
            display: block; 
            width: 100% !important; 
            height: 100% !important;
        }
        /* دکمه شروع فقط قبل از ورود به AR دیده می‌شود */
        #start-btn {
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            padding: 15px 40px; background: white; color: black; border: none;
            font-size: 18px; border-radius: 5px; z-index: 10;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <button id="start-btn">START CAMERA</button>

    <script type="module">
        import * as THREE from 'three';

        let camera, scene, renderer;
        let mesh;
        const startBtn = document.getElementById('start-btn');
        
        // تنظیمات عکس
        const IMAGE_URL = 'target.jpg';
        const IMAGE_WIDTH = 0.2;

        init();

        function init() {
            // 1. تنظیمات صحنه (بسیار مهم: بدون بک‌گراند)
            scene = new THREE.Scene();
            
            // 2. دوربین
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // 3. نور
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
            scene.add(light);

            // 4. رندرر (حیاتی‌ترین بخش برای رفع سیاهی)
            renderer = new THREE.WebGLRenderer({ 
                antialias: true, 
                alpha: true, // اجازه شفافیت
                preserveDrawingBuffer: true // گاهی برای اندروید لازم است
            });
            renderer.setPixelRatio(1); // پیکسل ریشیو را روی 1 قفل می‌کنیم تا باگ ندهد
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // پاک کردن سیاهی
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 5. آبجکت‌ها
            // الف) مکعب سبز (برای تست) - همیشه جلوی دوربین می‌چرخد
            const geo = new THREE.BoxGeometry(0.1, 0.1, 0.1);
            const mat = new THREE.MeshBasicMaterial({ color: 0x00ff00, wireframe: true });
            mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(0, 0, -0.5); // نیم متر جلوی دوربین
            scene.add(mesh); // اضافه کردن به صحنه

            // ب) مکعب قرمز (برای Image Tracking)
            const targetGeo = new THREE.BoxGeometry(0.15, 0.15, 0.15);
            const targetMat = new THREE.MeshStandardMaterial({ color: 0xff0000 });
            const targetMesh = new THREE.Mesh(targetGeo, targetMat);
            targetMesh.visible = false;
            targetMesh.matrixAutoUpdate = false;
            scene.add(targetMesh);

            // 6. لود عکس و راه اندازی دکمه
            setupAR(targetMesh);
            
            window.addEventListener('resize', onWindowResize);
        }

        async function setupAR(targetMesh) {
            try {
                // لود عکس
                const response = await fetch(IMAGE_URL);
                const blob = await response.blob();
                const imageBitmap = await createImageBitmap(blob);

                // رویداد کلیک دکمه
                startBtn.addEventListener('click', async () => {
                    // **مهم:** دکمه را کاملاً حذف می‌کنیم تا صفحه خالص شود
                    startBtn.style.display = 'none';

                    const session = await navigator.xr.requestSession('immersive-ar', {
                        requiredFeatures: [], // هیچ فیچر اجباری نمی‌گذاریم
                        optionalFeatures: ['image-tracking'], // فقط عکس، بدون dom-overlay
                        trackedImages: [
                            {
                                image: imageBitmap,
                                widthInMeters: IMAGE_WIDTH
                            }
                        ]
                    });

                    renderer.xr.setReferenceSpaceType('local');
                    renderer.xr.setSession(session);

                    // حلقه رندر مخصوص AR
                    renderer.setAnimationLoop((timestamp, frame) => {
                        // چرخش مکعب سبز (تست)
                        mesh.rotation.x += 0.05;
                        mesh.rotation.y += 0.05;

                        // لاجیک Image Tracking
                        if (frame) {
                            const results = frame.getImageTrackingResults();
                            if (results && results.length > 0) {
                                const hit = results[0];
                                const pose = frame.getPose(hit.imageSpace, renderer.xr.getReferenceSpace());

                                if (pose) {
                                    targetMesh.visible = true;
                                    targetMesh.matrix.fromArray(pose.transform.matrix);
                                } else {
                                    targetMesh.visible = false;
                                }
                            }
                        }
                        renderer.render(scene, camera);
                    });
                });

            } catch (err) {
                alert("Error: " + err.message);
                startBtn.textContent = "Error Loading";
            }
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>
