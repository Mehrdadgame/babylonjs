<!DOCTYPE html>
<html lang="en">
<head>
    <title>Three.js Image Tracking Final</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
        /* تنظیمات شفافیت (همان تنظیماتی که صفحه سیاه را درست کرد) */
        body { margin: 0; background-color: transparent !important; overflow: hidden; }
        canvas { display: block; }
        
        /* استایل متن وضعیت */
        #status {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: #00ffff;
            padding: 10px 20px; border-radius: 20px;
            font-family: sans-serif; font-weight: bold; font-size: 16px;
            pointer-events: none; z-index: 1000;
        }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="status">Loading target.jpg...</div>

    <script type="module">
        import * as THREE from 'three';
        import { ARButton } from 'three/addons/webxr/ARButton.js';

        let camera, scene, renderer;
        let trackedMesh;
        const statusDiv = document.getElementById('status');

        // تنظیمات عکس
        const IMAGE_URL = 'target.jpg';
        const IMAGE_WIDTH = 0.2; // 20 سانتیمتر

        init();

        async function init() {
            const container = document.createElement('div');
            document.body.appendChild(container);

            // 1. صحنه (حتماً background null باشد)
            scene = new THREE.Scene();
            scene.background = null;

            // 2. دوربین
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);

            // 3. نور
            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 3);
            scene.add(light);

            // 4. رندرر (با تنظیمات شفافیت)
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setClearColor(0x000000, 0); // پاک کردن رنگ پس‌زمینه
            renderer.xr.enabled = true;
            renderer.xr.setReferenceSpaceType('local');
            container.appendChild(renderer.domElement);

            // 5. ساخت آبجکت (مکعب قرمز)
            const geometry = new THREE.BoxGeometry(0.15, 0.15, 0.15);
            const material = new THREE.MeshStandardMaterial({ color: 0xff0000, wireframe: false });
            trackedMesh = new THREE.Mesh(geometry, material);
            
            // مهم: غیرفعال کردن آپدیت خودکار ماتریس (چون AR آن را کنترل می‌کند)
            trackedMesh.matrixAutoUpdate = false; 
            trackedMesh.visible = false; // اولش مخفی
            scene.add(trackedMesh);

            // 6. لود کردن عکس و ساخت دکمه AR
            try {
                const response = await fetch(IMAGE_URL);
                const blob = await response.blob();
                const imageBitmap = await createImageBitmap(blob);

                statusDiv.innerHTML = "Image Loaded. Click Start AR.";

                // ساخت دکمه AR با تنظیمات Image Tracking
                const button = ARButton.createButton(renderer, {
                    requiredFeatures: [], // خالی می‌گذاریم تا سخت‌گیری نکند
                    optionalFeatures: ['image-tracking', 'dom-overlay'], // اینجا درخواست می‌دهیم
                    trackedImages: [
                        {
                            image: imageBitmap,
                            widthInMeters: IMAGE_WIDTH
                        }
                    ],
                    domOverlay: { root: document.body }
                });
                document.body.appendChild(button);

            } catch (err) {
                console.error(err);
                statusDiv.innerHTML = "Error loading image: " + err.message;
                statusDiv.style.color = "red";
            }

            window.addEventListener('resize', onWindowResize);
            renderer.setAnimationLoop(render);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function render(timestamp, frame) {
            if (frame) {
                const results = frame.getImageTrackingResults();

                // اگر سیستم Image Tracking فعال باشد و نتیجه‌ای داشته باشد
                if (results && results.length > 0) {
                    const hit = results[0];
                    const pose = frame.getPose(hit.imageSpace, renderer.xr.getReferenceSpace());

                    if (pose) {
                        // عکس پیدا شد!
                        trackedMesh.visible = true;
                        // انتقال مکعب به مکان عکس
                        trackedMesh.matrix.fromArray(pose.transform.matrix);
                        
                        statusDiv.innerHTML = "TARGET FOUND!";
                        statusDiv.style.color = "#00ff00"; // سبز
                    } else {
                        statusDiv.innerHTML = "Scanning...";
                        statusDiv.style.color = "yellow";
                    }
                } else {
                    trackedMesh.visible = false;
                    statusDiv.innerHTML = "Scanning... (Point at target.jpg)";
                }
            }

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
